На основе предоставленных концептуальных и дизайн-документов, вот подробный план реализации Шага 2: **"Реализовать карту и ее генерацию"** для игры "Defense of the Nexus" на Rust с использованием Bevy:

---

### **Шаг 2: Реализовать карту и её генерацию**

#### **Цель**
Создать систему процедурной генерации карты первого уровня, которая включает сетку с различными типами ландшафта (например, земля, стены, препятствия) и предоставляет основу для размещения защитных сооружений и перемещения юнитов.

---

#### **Подробный план действий**

1. **Создать структуру карты**
    - Определить размер карты (например, 20x20 тайлов для первого уровня).
    - Реализовать структуру данных для хранения тайлов карты:
      ```rust
      struct Tile {
          terrain: TerrainType, // Тип ландшафта
          occupied: bool,       // Занятость тайла объектом
      }
 
      enum TerrainType {
          Ground,    // Проходимая земля
          Wall,      // Непроходимая стена
          Obstacle,  // Препятствия (например, камни)
      }
      ```

2. **Добавить поддержку процедурной генерации**
    - Использовать алгоритмы генерации карты:
        - **Perlin Noise**:
            - Для создания плавных переходов между различными типами ландшафта.
            - Библиотека [`noise`](https://crates.io/crates/noise) может быть использована для реализации Perlin Noise.
        - **Случайное распределение объектов**:
            - Сгенерировать случайные препятствия и стены с помощью генератора случайных чисел.
    - Реализовать функцию, которая создает массив тайлов на основе генерации:
      ```rust
      fn generate_map(width: usize, height: usize) -> Vec<Vec<Tile>> {
          // Инициализация карты
          let mut map = vec![vec![Tile { terrain: TerrainType::Ground, occupied: false }; width]; height];
 
          // Добавить случайные препятствия и стены
          for y in 0..height {
              for x in 0..width {
                  if some_random_condition() {
                      map[y][x].terrain = TerrainType::Wall;
                  }
              }
          }
 
          map
      }
      ```

3. **Интеграция карты в Bevy**
    - **Компоненты карты**:
        - Определить компонент `Map` и добавить его в систему Bevy.
    - **Отрисовка тайлов**:
        - Для визуализации карты использовать `SpriteBundle`:
          ```rust
          fn render_map(commands: &mut Commands, map: Vec<Vec<Tile>>, tile_size: f32) {
              for (y, row) in map.iter().enumerate() {
                  for (x, tile) in row.iter().enumerate() {
                      let sprite = match tile.terrain {
                          TerrainType::Ground => "ground_texture.png",
                          TerrainType::Wall => "wall_texture.png",
                          TerrainType::Obstacle => "obstacle_texture.png",
                      };
   
                      commands.spawn_bundle(SpriteBundle {
                          texture: asset_server.load(sprite),
                          transform: Transform {
                              translation: Vec3::new(x as f32 * tile_size, y as f32 * tile_size, 0.0),
                              ..Default::default()
                          },
                          ..Default::default()
                      });
                  }
              }
          }
          ```

4. **Добавить возможность взаимодействия с картой**
    - Реализовать функции:
        - Проверка проходимости тайла.
        - Определение возможных мест для размещения зданий и юнитов.
    - Например:
      ```rust
      fn is_walkable(tile: &Tile) -> bool {
          matches!(tile.terrain, TerrainType::Ground)
      }
      ```

5. **Добавить тестирование и отладку**
    - Создать несколько тестов для проверки правильности генерации:
        - Карта должна содержать определенный процент проходимых тайлов.
        - Тайлы с препятствиями должны генерироваться в случайных местах.
    - Реализовать отладочный режим, отображающий карту в упрощенном виде (например, через символы в консоли).

---

#### **Расширения**
- **Добавление динамического окружения**:
    - Реализовать возможность изменения карты во время игры (например, разрушение препятствий врагами).
- **Различные биомы**:
    - Включить дополнительные типы ландшафта (вода, лес).
    - Использовать параметры генерации для создания уникальных карт для разных уровней.

#### **Результат**
После выполнения этого шага вы получите полностью рабочую систему генерации карты, которая станет основой для дальнейшего развития игры.